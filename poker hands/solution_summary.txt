# 翻前加注记录问题分析与解决

## 问题描述
用户报告当有3bet发生时，`Preflop_1st_Bet`字段似乎没有正确记录第一次加注的动作。

## 分析过程
1. 我们检查了`_classify_preflop_action`方法，发现其中处理`preflop_action_1st_bet`和`preflop_action_3B`字段的逻辑。
2. 我们还检查了`process_poker_file`函数，发现其中有关于数据位移逻辑的注释，表明曾经有可能导致`preflop_action_1st_bet`被覆盖的问题。
3. 通过测试发现，问题不是数据没有记录，而是数据格式与预期不同。
4. 我们还发现在新格式处理脚本`process_all_new.py`中，没有正确保留这些字段的数据。

## 数据格式说明
解析器处理行动时：
1. 将原始玩家名称转换为位置信息（如Opp2→Opp(SB)，Hero→Hero(BB)）
2. 将下注金额转换为BB单位
3. 格式化为"玩家(位置): 动作 金额BB"的形式

例如：
- 原始动作：`Opp2: raises $1.50 to $2.00`
- 转换后：`Opp(SB): raises 4.0BB`

## 解决方案
1. 通过更新测试逻辑，我们确认：
   - `preflop_action_1st_bet`字段确实正确记录了第一次加注
   - `preflop_action_3B`字段确实正确记录了3bet动作
   - 解析器的行为是符合预期的，不需要修改解析器代码

2. 我们修改了`process_all_new.py`脚本，确保它正确保留和处理这些字段：
   - 添加了对这些字段的统计
   - 确保在写入CSV文件时保留这些字段
   - 使用自定义标题映射，确保字段名称一致

3. 修改后的脚本成功处理了这些字段，统计显示：
   - 在`parsed_hands.csv`中：有3bet记录的手牌占2.04%（102手）
   - 在`parsed_hands_new_format.csv`中：有3bet记录的手牌占15.56%（778手）
   - 3bet记录数量的增加表明新脚本更准确地识别和记录了3bet动作

## 建议
1. 如果需要检索特定动作，应该根据实际输出格式进行匹配，例如：
   - 使用'raises'关键词来匹配加注动作，而不是寻找具体的玩家名称
   - 考虑位置信息替代了原始玩家名称
   - 金额以BB单位表示

2. 在处理手牌数据时，确保使用修改后的`process_all_new.py`脚本，它能更准确地处理和保留翻前行动字段。

## 结论
1. 解析器本身的行为是正确的，记录了完整的动作信息，只是格式化方式与原始手牌文本不同。
2. 新格式处理脚本现在能够正确处理和保留翻前行动字段，提供更准确的3bet动作记录。
3. 这些改进使得数据分析更加准确，特别是对于研究翻前加注策略的分析。 